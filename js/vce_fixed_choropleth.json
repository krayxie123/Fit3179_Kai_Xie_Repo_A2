{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "VCE Performance Choropleth Map - Fixed Version",
  "params": [
    {
      "name": "selected_year",
      "value": 2024,
      "bind": {
        "input": "range",
        "min": 2014,
        "max": 2024,
        "step": 1,
        "name": "Year: "
      }
    }
  ],
  "width": 700,
  "height": 500,
  "projection": {
    "type": "equirectangular",
    "center": [145, -37.7],
    "scale": 20000
  },
  "data": {
    "url": "js/vicsuburbsgood.topojson",
    "format": {"type": "topojson", "feature": "Vicsubs.topojson"}
  },
  "layer": [
    {
      "mark": {"type": "geoshape", "fill": "lightgray", "stroke": "white"},
      "encoding": {
        "tooltip": {
          "field": "properties.vic_loca_2"
        }
      }
    },
    {
      "transform": [
        {
          "lookup": "properties.vic_loca_2",
          "from": {
            "data": {
              "url": "data/VCE_School_Results.csv",
              "format": {"type": "csv", "parse": {"year": "number", "median_vce_ss": "string"}}
            },
            "key": "locality",
            "fields": ["median_vce_ss", "school", "year"]
          }
        },
        {
          "filter": "datum.year == selected_year"
        },
        {
          "filter": "datum.median_vce_ss != null && datum.median_vce_ss != '-' && datum.median_vce_ss != '' && datum.median_vce_ss != 'I/D'"
        },
        {
          "calculate": "parseFloat(datum.median_vce_ss)",
          "as": "study_score"
        },
        {
          "filter": "datum.study_score > 0 && !isNaN(datum.study_score)"
        }
      ],
      "mark": {"type": "geoshape", "stroke": "white"},
      "encoding": {
        "color": {
          "field": "study_score",
          "type": "quantitative",
          "scale": {
            "domain": [15, 45],
            "range": ["#2166ac", "#4393c3", "#92c5de", "#d1e5f0", "#f7f7f7", "#fddbc7", "#f4a582", "#d6604d", "#b2182b"]
          },
          "legend": {
            "title": "VCE Study Score",
            "orient": "right"
          }
        },
        "tooltip": [
          {"field": "properties.vic_loca_2", "type": "nominal", "title": "Locality"},
          {"field": "study_score", "type": "quantitative", "title": "VCE Study Score", "format": ".1f"},
          {"field": "school", "type": "nominal", "title": "School"},
          {"field": "year", "type": "ordinal", "title": "Year"}
        ]
      }
    },
    {
      "data": {"graticule": {"step": [1, 1]}},
      "mark": {"type": "geoshape", "stroke": "grey", "strokeWidth": 0.5, "fill": null}
    }
  ]
}
